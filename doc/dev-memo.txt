# OSé–‹ç™ºãƒ¡ãƒ¢

## 2019-04-20

### å‚è€ƒURL
*  GRUB2ã‹ã‚‰ã®èµ·å‹•ãƒ—ãƒ­ã‚°ãƒ©ãƒ 
    - URL: https://qiita.com/sp6/items/228e63030ea0124e42c0
* Macã§ã®é–‹ç™º(ã‚¯ãƒ­ã‚¹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ç’°å¢ƒ)
    - URL1: http://morimolymoly.hateblo.jp/entry/2017/12/31/144712
    - URL2: https://qiita.com/tatsumack/items/9f1ae8dee4dbb33b7406
    - URL3: http://morimolymoly.hateblo.jp/entry/2017/12/31/144712
    - URL4: https://qiita.com/yakawa/items/b4d3abc7dabd84013de1

### ã‚¯ãƒ­ã‚¹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ç’°å¢ƒæ§‹ç¯‰æ‰‹é †

#### æº–å‚™

argent-2:binutils-2.32 eiji$ brew install gmp    â†ã™ã§ã«å…¥ã£ã¦ã„ãŸ
argent-2:binutils-2.32 eiji$ brew install mpfr
Updating Homebrew...
==> Downloading https://homebrew.bintray.com/bottles/mpfr-4.0.2.high_sierra.bott
==> Downloading from https://akamai.bintray.com/bf/bf5d21e7e8e549f7e8d07791a90f4
######################################################################## 100.0%
==> Pouring mpfr-4.0.2.high_sierra.bottle.tar.gz
ğŸº  /usr/local/Cellar/mpfr/4.0.2: 28 files, 4.7MB
argent-2:binutils-2.32 eiji$ brew install libmpc
==> Downloading https://homebrew.bintray.com/bottles/libmpc-1.1.0.high_sierra.bo
######################################################################## 100.0%
==> Pouring libmpc-1.1.0.high_sierra.bottle.tar.gz
ğŸº  /usr/local/Cellar/libmpc/1.1.0: 12 files, 353.8KB

â€» gccã‚’å…¥ã‚Œæ›ãˆ
argent-2:binutils-2.32 eiji$ brew install gcc

  â† gcc-8ãŒå…¥ã£ãŸ(8.3.0)

â€» gmake ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
argent-2:gcc-8.3.0 eiji$ brew install gmake



argent-2:~ eiji$ export CC=/usr/local/bin/gcc-8
argent-2:~ eiji$ export LD=/usr/local/bin/gcc-8
argent-2:~ eiji$ export PREFIX="/usr/local/i386elfgcc"
argent-2:~ eiji$ export TARGET=i386-elf
argent-2:~ eiji$ export PATH="$PREFIX/bin:$PATH"
argent-2:~ eiji$ 
argent-2:~ eiji$ mkdir tmp/src
argent-2:~ eiji$ cd tmp/src

â€» gwakãŒãªã„ã¨æ€’ã‚‰ã‚Œã‚‹ã®ã§
argent-2:binutils-2.32 eiji$ brew install gawk
Updating Homebrew...
==> Installing dependencies for gawk: readline
==> Installing gawk dependency: readline
==> Downloading https://homebrew.bintray.com/bottles/readline-8.0.0.high_sierra.
==> Downloading from https://akamai.bintray.com/9f/9f5c4da065626612770b0176f5eca
######################################################################## 100.0%
==> Pouring readline-8.0.0.high_sierra.bottle.tar.gz
==> Caveats
readline is keg-only, which means it was not symlinked into /usr/local,
because macOS provides the BSD libedit library, which shadows libreadline.
In order to prevent conflicts when programs look for libreadline we are
defaulting this GNU Readline installation to keg-only.

For compilers to find readline you may need to set:
  export LDFLAGS="-L/usr/local/opt/readline/lib"
  export CPPFLAGS="-I/usr/local/opt/readline/include"

For pkg-config to find readline you may need to set:
  export PKG_CONFIG_PATH="/usr/local/opt/readline/lib/pkgconfig"

==> Summary
ğŸº  /usr/local/Cellar/readline/8.0.0: 48 files, 1.5MB
==> Installing gawk
==> Downloading https://homebrew.bintray.com/bottles/gawk-5.0.0.high_sierra.bott
==> Downloading from https://akamai.bintray.com/8b/8b935dbbfcc134e9f546399fc16ec
######################################################################## 100.0%
==> Pouring gawk-5.0.0.high_sierra.bottle.tar.gz
ğŸº  /usr/local/Cellar/gawk/5.0.0: 89 files, 4.6MB
==> Caveats
==> readline
readline is keg-only, which means it was not symlinked into /usr/local,
because macOS provides the BSD libedit library, which shadows libreadline.
In order to prevent conflicts when programs look for libreadline we are
defaulting this GNU Readline installation to keg-only.

For compilers to find readline you may need to set:
  export LDFLAGS="-L/usr/local/opt/readline/lib"
  export CPPFLAGS="-I/usr/local/opt/readline/include"

For pkg-config to find readline you may need to set:
  export PKG_CONFIG_PATH="/usr/local/opt/readline/lib/pkgconfig"

---(gawkã“ã“ã¾ã§)

#### binutilesã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
argent-2:src eiji$ curl -O http://ftp.gnu.org/gnu/binutils/binutils-2.32.tar.gz
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 39.2M  100 39.2M    0     0   261k      0  0:02:33  0:02:33 --:--:--  489k

â€» binutils
argent-2:binutils-2.32 eiji$ ./configure --target=$TARGET --enable-interwork --enable-multilib --disable-nls --disable-werror --prefix=$PREFIX 2>&1 | tee configure.log

â€» libiconv

argent-2:src eiji$ curl -O https://ftp.gnu.org/pub/gnu/libiconv/libiconv-1.15.tar.gz
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 5140k  100 5140k    0     0   257k      0  0:00:19  0:00:19 --:--:--  106k
argent-2:src eiji$ 
argent-2:src eiji$ 
argent-2:src eiji$ 
argent-2:src eiji$ tar zxf libiconv-1.15.tar.gz 
argent-2:src eiji$ cd libiconv-1.15
argent-2:libiconv-1.15 eiji$ ./configure -prefix=/usr/local

make
sudo make install

â€» ã‚¯ãƒ­ã‚¹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ç”¨gcc

argent-2:src eiji$ curl -O https://ftp.gnu.org/gnu/gcc/gcc-8.3.0/gcc-8.3.0.tar.gz
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  108M  100  108M    0     0   149k      0  0:12:28  0:12:28 --:--:--  128k
argent-2:src eiji$ tar zxf gcc-8.3.0.tar.gz 
mkdir gcc-build    â† makeã«ã¯åˆ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œã‚‰ãªã„ã¨ã„ã‘ãªã„
cd gcc-build
argent-2:gcc-8.3.0 eiji$ ../gcc-8.3.0/configure --target=$TARGET --prefix="$PREFIX" --disable-nls --disable-libssp --enable-languages=c --without-headers --with-gmp=/usr/local --with-mpfr=/usr/local --with-mpfr=/usr/local --with-libiconv-prefix=/usr/local

make all-gcc 
make all-target-libgcc 
sudo make install-gcc 
sudo make install-target-libgcc

/usr/local/i386elfgcc/bin/i386-elf-gcc -v    â†ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯

* objconvã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«(GRUB2ã«å¿…è¦)
    -URL: https://www.agner.org/optimize/objconv.zip

    â€» curlã§ã¨ã£ã¦ãã¦unzipã‚³ãƒãƒ³ãƒ‰ã§å±•é–‹ã—ã‚ˆã†ã¨ã—ã¦ã‚‚ã†ã¾ãã„ã‹ãªã„

    zipã‚’é–‹ã„ã¦ä¸­ã®source.zipã‚’ã•ã‚‰ã«å±•é–‹ã™ã‚‹ã€‚

cd source
sh build.sh
argent-2:source eiji$ sudo cp objconv /usr/local/bin/

* GRUB2ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

argent-2:src eiji$ curl -O https://ftp.gnu.org/gnu/grub/grub-2.02.tar.gz
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 10.0M  100 10.0M    0     0  2763k      0  0:00:03  0:00:03 --:--:-- 2763k
argent-2:src eiji$ tar zxf grub-2.02.tar.gz 
argent-2:src eiji$ cd grub-2.02

* GRUB2ã®ã‚µãƒ³ãƒ—ãƒ«OSã‚’å‹•ã‹ã™

    - URL: https://qiita.com/sp6/items/228e63030ea0124e42c0

argent-2:grub-2.02 eiji$ tar zxf grub-2.02.tar.gz 
argent-2:grub-2.02 eiji$ cd grub-2.02
argent-2:grub-2.02 eiji$ ./autogen.sh
./configure
make

----GRUB2ãƒ‘ãƒƒãƒ

  â€» GCC 8ç³»çµ±ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼
  "error: alignment 1 of â€˜struct grub_gpt_partentryâ€™ is less than 8 [-Werror=packed-not-aligned]"

  - URL: https://lists.gnu.org/archive/html/grub-devel/2018-03/msg00085.html

ãƒ‘ãƒƒãƒã‚’å½“ã¦ã‚‹
---
 grub-core/fs/btrfs.c          | 2 +-
 include/grub/efiemu/runtime.h | 2 +-
 include/grub/gpt_partition.h  | 2 +-
 3 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/grub-core/fs/btrfs.c b/grub-core/fs/btrfs.c
index 4849c1ceb..be195448d 100644
--- a/grub-core/fs/btrfs.c
+++ b/grub-core/fs/btrfs.c
@@ -175,7 +175,7 @@ struct grub_btrfs_time
 {
   grub_int64_t sec;
   grub_uint32_t nanosec;
-} __attribute__ ((aligned (4)));
+} GRUB_PACKED;
 
 struct grub_btrfs_inode
 {
diff --git a/include/grub/efiemu/runtime.h b/include/grub/efiemu/runtime.h
index 9b6b729f4..36d2dedf4 100644
--- a/include/grub/efiemu/runtime.h
+++ b/include/grub/efiemu/runtime.h
@@ -29,7 +29,7 @@ struct grub_efiemu_ptv_rel
 
 struct efi_variable
 {
-  grub_efi_guid_t guid;
+  grub_efi_packed_guid_t guid;
   grub_uint32_t namelen;
   grub_uint32_t size;
   grub_efi_uint32_t attributes;
diff --git a/include/grub/gpt_partition.h b/include/grub/gpt_partition.h
index 1b32f6725..9668a68c3 100644
--- a/include/grub/gpt_partition.h
+++ b/include/grub/gpt_partition.h
@@ -28,7 +28,7 @@ struct grub_gpt_part_type
   grub_uint16_t data2;
   grub_uint16_t data3;
   grub_uint8_t data4[8];
-} __attribute__ ((aligned(8)));
+} GRUB_PACKED;
 typedef struct grub_gpt_part_type grub_gpt_part_type_t;
 
 #define GRUB_GPT_PARTITION_TYPE_EMPTY \
-- 
2.13.6

----ã“ã“ã¾ã§

configureã¯æ¬¡ã®ã‚ˆã†ã«å®Ÿæ–½ã€‚

mkdir dobuild
cd dobuild
../configure --disable-werror TARGET_CC=/usr/local/i386elfgcc/bin/i386-elf-gcc TARGET_OBJCOPY=/usr/local/i386elfgcc/bin/i386-elf-objcopy TARGET_STRIP=/usr/local/i386elfgcc/bin/i386-elf-strip TARGET_NM=/usr/local/i386elfgcc/bin/i386-elf-nm TARGET_RANLIB=/usr/local/i386elfgcc/lib/i386-elf-ranlib --target=i386-elf


makeã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã€‚

/var/folders/ds/wfbby30s4bz1j694wnx0rsdr0000gn/T//ccKvULdU.s:95:22: error: invalid variant 'PLTOFF'
        movabsq $_grub_free@PLTOFF, %rax

ãƒ¡ãƒ¢ãƒªãƒ¢ãƒ‡ãƒ«ãŒMacã§ã¯ã‚ã‚ãªã„ã‚‰ã—ã„ã€‚
configureã®"-mcmodel=large"ã‚’"-mcmodel=small"ã«ä¿®æ­£ã™ã‚‹ã€‚

æ¬¡ã®ã‚¨ãƒ©ãƒ¼

argent-2:grub-2.02 eiji$ make
/Applications/Xcode.app/Contents/Developer/usr/bin/make  all-recursive
Making all in grub-core/gnulib
/Applications/Xcode.app/Contents/Developer/usr/bin/make  all-recursive
make[4]: Nothing to be done for `all-am'.
Making all in .
Making all in grub-core
/Applications/Xcode.app/Contents/Developer/usr/bin/make  all-am
TARGET_OBJ2ELF= sh genmod.sh moddep.lst disk.module build-grub-module-verifier disk.mod

Input file: disk.mod.tmp.bin, output file: disk.mod.tmp
Converting from Mach-O Little Endian64 to ELF64
Removing leading underscores from symbol names
Changing leading underscores on section names to dot

  0 Debug sections removed
  0 Exception sections removed
 13 Changes in leading underscores on symbol names
  7 Changes in leading characters on section names
  2 Symbol names changed
build-grub-module-verifier: error: relocation 0x2 is not module-local.
make[3]: *** [disk.mod] Error 1
make[2]: *** [all] Error 2
make[1]: *** [all-recursive] Error 1
make: *** [all] Error 2

---

$ make
$ sudo make install


---

#### grub2ã§ISOã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹

anzu.elfã‹ã‚‰ISOã‚¤ãƒ¡ãƒ¼ã‚¸ä½œæˆæ™‚ã«ã‚¨ãƒ©ãƒ¼ã«ãªã£ãŸã€‚

grub-mkrescue: warning: Your xorriso doesn't support `--grub2-boot-info'. Some features are disabled. Please use xorriso 1.2.9 or later..

Homebrewã‹ã‚‰xorrisoã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

$ sudo chown -R $(whoami) /usr/local/sbin
$ brew install xorriso

### JHCã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«

æœ€åˆã«configureã‚’ä½œã‚‹

$ autoreconf --install

configureã‚’å®Ÿè¡Œã™ã‚‹ã€‚

$ ./configure

Some packages were not found:
 module 'Codec.Compression.Zlib' from package 'zlib'
 module 'Data.ByteString.UTF8' from package 'utf8-string'
 module 'Data.Yaml.Syck' from package 'HsSyck'
 module 'Text.Regex' from package 'regex-compat'

ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã€‚

$ cabal install zlib
$ cabal install utf8-string HsSyck regex-compat

å†åº¦ configure

$ ./configure

### DrIFT

jhcã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã«å¿…è¦

http://hackage.haskell.org/package/DrIFT ã‹ã‚‰å…¥æ‰‹

$ git clone http://hackage.haskell.org/package/DrIFT

$ autoreconf -i
$ ./configure
$ make cabal-install

### alex & happy

jhcã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã«å¿…è¦

$ cabal install alex happy

## ajhcã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

jhcã‚’è‹¦åŠ´ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã‚ˆã†ã¨ã—ãŸãŒã€ajhcãŒcabalã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¦ã—ã¾,,,
ã‚ãªã‹ã£ãŸã€‚

$ cabal install ajhc
ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã€‚

ã‚½ãƒ¼ã‚¹ã‚’æŒã£ã¦ãã¦ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦è¦‹ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã€‚

src/Doc/DocLike.hs

---
import Prelude hiding ((<$>))
---

ã‚’è¿½åŠ ã™ã‚‹ã€‚

#### Rustã§OSã‚’ä½œã‚‹å‚è€ƒæƒ…å ±

https://qiita.com/tomoyuki-nakabayashi/items/76f912adb6b7da6030c7

Rustã«Linuxã®targetã‚’è¿½åŠ ã™ã‚‹ã€‚ã¾ãšã¯rustupã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

$ brew install rustup

targetã¨ã—ã¦i686ç”¨ã‚’è¿½åŠ 

$ rustup target add i686-unknown-linux-gnu


/usr/local/i386elfgcc/bin/i386-elf-ld  -melf_i386  -Ttext=0x100000 --oformat elf32-i386 -o anzu.elf boot.o ../../target/i686-unknown-linux-gnu/debug/libanzu.a

#### Rust ã‚³ã‚¢ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

ã‚³ã‚¢ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒãªã„ã¨ä¾¿åˆ©ãªæ©Ÿèƒ½ãŒä½¿ãˆãªã„ã€‚ä¸‹è¨˜ã«èª¬æ˜ãŒã‚ã‚‹ã€‚

http://mmi.hatenablog.com/entry/2017/07/27/230005

## çµå±€ã‚„ã£ãŸã“ã¨

* i686-ELFå‘ã‘GCCã®å°å…¥

* Rust ã‚¯ãƒ­ã‚¹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ç’°å¢ƒï¼ˆtoolchainï¼‰

* Rust nightly ç‰ˆã®ä½¿ç”¨

* xargo ã®ä½¿ç”¨

* coreãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å°å…¥

* Cargo.toml ã¸panicé–¢æ•°ã®ä»¶ã‚’è¨˜è¼‰


        
    